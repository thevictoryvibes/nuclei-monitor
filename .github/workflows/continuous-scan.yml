name: Continuous Vulnerability Monitoring

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'websites.txt'

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: pip install requests
      
      - name: Run Vulnerability Scan
        id: scan
        env:
          SCANNER_API_URL: ${{ secrets.SCANNER_API_URL }}
        run: python scan_script.py
      
      - name: Cleanup Old Files
        run: |
          find results/ -name "scan_*.json" -type f -mtime +15 -delete || true
          find reports/ -name "daily_report_*.md" -type f -mtime +15 -delete || true
      
      - name: Commit Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add results/ reports/ MONITORING_STATUS.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Scan results - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          fi
      
      - name: Send Email Notification
        if: steps.scan.outputs.total_vulns > 0
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'Vulnerabilities Detected'
          to: ${{ secrets.EMAIL_USERNAME }}
          from: Nuclei Monitor
          body: |
            Vulnerability scan completed!
            
            Vulnerabilities found: ${{ steps.scan.outputs.total_vulns }}
            Failed scans: ${{ steps.scan.outputs.failed_scans }}
            
            View dashboard: https://thevictoryvibes.github.io/nuclei-monitor/dashboard.html
      
      - name: Summary
        run: |
          echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerabilities:** ${{ steps.scan.outputs.total_vulns }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ${{ steps.scan.outputs.failed_scans }}" >> $GITHUB_STEP_SUMMARY
